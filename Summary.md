# S—NeRF

## 摘要

1.学习没有标签或形状先验：它由图像重建的损失自我监督。

> 标签：所预测的事物的实际情况。形状先验：对物体进行理想化的假设。损失自我监督：loss函数。

2.为了适应来自定向光源和漫射光源的可变光源条件，我们以两种方式**扩展了NeRF方法。**首先，**太阳的直接照明**通过局部光源可见场建模。第二，来自**漫射光源的间接照明（sky）**是作为太阳分布的非局部着色场。**定量地说，与NeRF相比，这些方法的组合减少了阴影区域的高度和颜色误差**。

>  相比NeRF，S-NeRF在卫星上的应用增加了与直接照明（sun）和间接照明（sky）的有关参量，实现了对阴影更高质量的估计。

3.这些图像(Figure2)表现出很强的不相关性，因为它们是在不同的时刻拍摄的(光照条件的变化,由于来自天空的环境影响,阴影不容易被探测到)。其次,视角的数量和分布都受到了限制。

> 与地球上计算机图形学的不同，也就是S-NeRF需要解决的两个问题。

## 相关工作

* 立体声匹配

  在基于卫星的语音测量技术中，许多工作都集中在立体声匹配上在这个范例中表面表示类型 （x，y）= h的bya函数，称为空间图（DEM） ，其中**( x ，y）纬度、经度，h是相应的空间高度**。这些方法明确地匹配像素对或三联体，即一组匹配的光线必须在场景中物体的表面相交。

  **图像之间的阴影运动会使其难以准确地测量空间特征。**其他与时间不相关的来源包括镜面效应 、瞬态物体（如汽车） 、植被生长、土地覆盖变化和天气现象（如雪） 。这些不一致的影响通过使用类似条件下的成对或三组图像来减少：大致在一天的同一时间， 和一年的同一时间。

  > 将不同的时间元素匹配在一起，削减由于由于不同时刻对空间模拟的影响（？）

* NeRF

  **运用MLP隐式存储3D信息**

  * 训练

    解决逆渲染问题意味着学习**场景中每个元素对最终感知颜色的贡献**。为了训练一个神经体积表示，使其与图像数据集匹配，首先从所有图像中随机采样一批Nb个像素。然后，通过对应的射线估计每个像素的感知颜色ˆI(r)。根据估计结果，会得到每个像素的损失值，并将其通过反向传播更新神经网络的权重。通过这种方式，神经体积表示会被调整，以更好地与训练图像中的观察结果匹配。需要注意的是，梯度下降优化之所以可行，是因为无论是表示函数还是渲染函数都是可微的。

  * Fully渲染模型

<img src="Fully.jpg">



公式中，渲染结果的近似值（I）是每个采样位置颜色向量（ci）的加权和，权重wi由两个因素决定：

- αi：表示射线第i段的透明度，值介于0和1之间。
- Ti：是从射线原点到第i段的透明度的累积值，表示该段射线是否被先前的段阻挡。

具体来说：

- αi是第i段的透明度，与射线段的长度δxi和吸收系数σi有关。
- Ti是从射线起始点到当前射线段的透明度累积，体现了射线是否被之前的透明物质阻挡。

较高的wi值表示该射线段具有较强的发光或反射能力（即高αi），并且之前的段没有显著阻挡光的传播（即高Ti）。

简而言之，这个方法通过在每条射线上采样并加权计算颜色值，模拟了光在体积中的传播与散射，从而得出最终的图像。

**神经反射场（Neural Reflectance Fields）** 最近被引入用于3D场景的重光照（relighting）。这种方法通过计算每个查询点与光源之间的可见性，实时推理在空间位置上到达的光量。在训练神经反射场时，如果使用的是具有已知非共定位光源（例如多个光源）的图像，那么为了估计光传输函数，所需的采样点数将呈二次甚至三次增长，这对于实际应用，特别是内存来说是非常不利的。因此，神经反射场只能在使用与**观察轴共定位的白光源**（例如相机闪光灯）的图像上进行训练。尽管如此，神经反射场在提取表面参数（如反照率albedo）和对复杂结构（如精细元素）的物体进行准确重光照方面仍然取得了成功。

与神经反射场不同，我们的方法提出了一种不同的策略，尤其是在多视角卫星图像（以及许多其他情况）中，光源通常**与相机轴不共定位**。为此，我们的方法将光照条件限制为地球上两个主要的光源：太阳和天空。通过显式了解太阳方向，我们简化了完整的光学体积渲染公式。此外，我们的方法优先考虑保持与射线采样点数量的线性复杂度（O(Ns)），这与NeRF（神经辐射场）相同。

## 方法

#### 辐照度模型

**光照表示**：

- 通过引入两个网络输出 s(x,ωs) 和 sky(ωs)，对入射光的变化进行建模。

  >  s(x,ωs):入射光沿着太阳方向的可见性
  >
  > sky(ωs)是一个学习的向量，表示从天空入射的光的颜色（RGB），它仅依赖于太阳方向，而不依赖于空间坐标，用于表示阴影区域的漫射光源。

**辐射照度公式**：

- 总辐射照度被建模为一个加权和，结合了已知的白光光源和由网络预测的天空光颜色

- 辐射 c(x,ωs)则通过点乘模型结合了入射的辐射照度和物体的反射率（albedo）

  <img src="辐射.png">

**渲染与阴影**：

- 采用 Lambertian 反射模型，通过辐射照度和反射率计算场景中的光照效果。具体的感知色彩是各个光源权重和颜色的加权和。

- 该方法简化了光照模型，避免了在训练时的额外采样，但并未考虑高阶效应，如镜面反射和间接光照（例如光的二次反射）。此外，所有阴影区域的天空光照被假设为均匀，场景的遮挡效应未被考虑。

  <img src="渲染.png">

#### 太阳校正射线

<img src="射线.png">

**太阳校正射线的作用**：在每次训练迭代时，除了常规的射线，还会生成一组额外的“太阳校正射线”。这些射线的目的是根据当前估算的场景几何形状来校正太阳可见性函数。沿着这些射线计算透明度 Ti，并将其与目标透明度 si进行比较，以调整优化目标。

**损失函数的组成**：损失函数 L(b) 包括三部分：

- **像素级RGB损失**：通过均方误差（MSE）度量网络预测的像素 Is^(r)与真实图像像素 I(r)之间的差异。
- **太阳校正射线上的透明度损失**：计算太阳校正射线 SC上透明度 Ti 和目标透明度 si之间的L2损失。为了使透明度T更接近目标透明度 s,在计算过程中停止 T的梯度更新。
- **吸收损失**：通过计算 L1范数，表达所有太阳光应被可见表面吸收的理念。该项损失的梯度也被停止。

**权重参数 λs**：这是一个超参数，用于平衡不同损失项的权重，表示颜色准确性与阴影有效性之间的折衷。在实验中，选择 λs=0.05取得了最佳效果。

**太阳校正射线的生成方式**：太阳校正射线可以从上半球随机生成，或者集中在某些特定的角度位置。实验中，采用了沿太阳路径插值轴生成太阳校正射线，图5展示了太阳校正对在与训练条件显著不同的光照条件下泛化的影响。

#### 基于高度的采样

**采样沿Z轴**：该方案的核心是将采样点沿绝对Z轴以规则间隔选择，而不是沿传感器轴（例如图像或视线方向）。这种做法更适合地球观测场景，因为在这些场景中，Z轴的范围通常较小，采用绝对Z轴采样可以更好地适应这种几何结构。

**基于高度采样**：采样是在给定区域的最小和最大高度值之间进行的，而不是基于近远距离，这样做避免了引入与卫星配置相关的参数。最小和最大高度值可以通过不同方式获取，例如从低分辨率的大规模数字地形图（Digital Terrain Map, DTM）中提取。在本文中，最小和最大高度值是基于机载LiDAR（激光雷达）地图的最小值和最大值来选择的（表1中的第3行）。

**重要性采样**：文中还提到，采用重要性采样（importance sampling）方法，仅对视觉射线进行采样。该方法可以提高在固定采样预算下的深度分辨率，优化了计算效率。

#### 神经网络

<img src="网络.png">

**该网络架构由四个部分组成。首先，密度输出通过8层全连接的SIREN网络与空间输入连接，使用ReLU激活函数并加噪声以提供高于1的输出。第二，RGB反射率通过sigmoid激活连接到密度网络的最后一层。接着，太阳能可见度与密度网络的输出及太阳方向连接，并用于估算天空颜色。该架构的主要创新是添加了太阳能可见度网络和天空颜色估计层。**

> 我们给出的代码将SIREN网络简化为最基础的神经网络，RGB简化为灰度。

> **密度（Density）**通常指的是场景中每个空间位置的物质密度，通常用于表示场景中物体的材质和光的吸收、散射等物理性质。

> 输入：
>
> **空间坐标（X, Y, Z）**：这些是3D空间中的位置坐标，用于定义每个点在场景中的位置。网络通过这些坐标来估计场景中每个位置的密度（density）、反射率（albedo）和其他属性。
>
> **太阳方向（𝜔𝑠）**：这是描述太阳光源方向的向量。太阳方向用于计算与太阳相关的可见度（solar visibility），并影响最终渲染效果，尤其是如何将太阳光照射到场景中。
>
> **网络内部的中间输出**：在网络的不同层之间，数据会通过不同的激活函数（如ReLU、sigmoid等）进行处理，传递前后的网络层之间。特别是在密度网络中，密度信息（经过ReLU激活）和太阳方向的输出会被传递到后续的太阳能可见度计算部分。
>
> 输出：
>
> **密度、反射率、太阳可见度、天空颜色**

> 与基础的NeRF联系(?)
>
> **空间位姿（pose）** 则更侧重于相机的视角，它决定了观测场景的方向和位置。在NeRF中，网络需要了解相机的位姿来合成从不同角度看到的图像。
>
> 与空间坐标、太阳方向的联系在于：空间坐标和太阳方向决定了场景的物理属性，而相机的位姿则是影响图像呈现的视角因素。在NeRF的渲染过程中，位姿、光照以及场景的几何信息（即该网络生成的四个输出）共同作用，生成最终的视觉效果。

## 实验

**新视图合成（SSIM）：** S-NeRF 的表现与 NeRF 相似，提供了与 NeRF 类似的图像质量。然而，S-NeRF 的表现略微优于 NeRF，尤其是在某些场景中，尽管太阳能修正（SC）并未显著改善图像质量。

**表面高度误差（Altitude MAE）：** S-NeRF 在所有场景中均表现出比 NeRF 更低的高度均方误差（MAE），表明其在表面形状重建方面更为准确。尽管太阳能修正对于 MAE 并未带来明显的改善，但其依旧显示出一定的提升空间。

> 没有阴影模型的 NeRF 渲染结果中，阴影区域较为模糊，且边缘不清晰，而使用 S-NeRF 后，阴影得到了更好的定位，且受到了柔和的蓝色环境光照射，阴影效果更为自然。
>
> S-NeRF 能保持一致的颜色表现，且由于 RGB 反射率值不依赖于光照条件，模型能够在不同太阳位置间平滑过渡。太阳能修正进一步优化了阴影的处理，使其与场景形状更加一致，特别是在之前未见过的条件下。
>
> NeRF 和 S-NeRF 在 SSIM（结构相似性指数）上得分相当。部分场景中，阴影区域质量的提高可能被整体暗化效果抵消，这在 **图2** 中有所体现。表格还表明，在3/4的评估场景中，使用太阳能修正后，SSIM 值维持或有所提升，只有在 **区域004**中，使用太阳能修正后 SSIM 值有所下降，这可能与该区域的海拔变化较小、阴影占比小有关。
>
> S-NeRF 能提供3D反射率估计，即使是在训练图像中完全处于阴影中的区域。这是因为模型能够学习到环境光的颜色及其对总光照的局部贡献。尽管无法通过实际数据进行精确量化，反射率估计结果仍然显示了 S-NeRF 的潜力。
>
> 最后，模型在估算反射率时排除了大多数动态物体（如车），并对它们进行了模糊处理，尤其在 **区域214**中，停车场中的车被有效过滤或模糊。这一特性对于新图像中的动态物体检测或语义分割（当这些物体不重要时）具有潜在应用价值。

> S-NeRF 提供了一个完整的 3D 密度模型，可以通过选择等密度面（iso-σ surface）并应用 **marching cubes** 算法提取表面边界。
>
> 高度对表面的重建具体起了什么作用(?)

## 讨论与总结

1. **NeRF和S-NeRF的局限性：**
   - NeRF及其变种需要为每个新场景重新训练神经网络，这限制了其扩展性。
   - 最近的研究致力于将这些模型推广到多个场景中，提升其紧凑性，并使其在多个场景中更具适应性。
   - 这些进展可能对多视角卫星影像的应用非常有价值。
2. **多场景的泛化：**
   - 研究者们正在努力使神经体积表示更紧凑且能适应不同场景，这对卫星影像任务可能带来重大帮助。
3. **更强的时序分析与物体过滤：**
   - 通过受NeRF in the Wild启发的潜在嵌入优化方法，可以实现更强大的瞬态物体过滤和更深层的时序分析。
   - 这种方法能够处理显著的光照变化，但仍未解决通用的光照重新渲染问题。
4. **神经反射和可见性场（NeRV）：**
   - NeRV旨在解决光源条件变化的问题，能够处理间接照明（包括镜面反射效应）。
   - 然而，NeRV需要预先知道光照条件（如天空颜色），并且在复杂性上引入了额外的线性项（复杂度从O(N)变为O(N+d)）。
5. **提出的解决方案 - S-NeRF：**
   - 本研究提出了**S-NeRF**，这是NeRF的一种新型适应性扩展，专为卫星图像设计，能够处理阴影和光照变化对3D形状估计的影响。
   - 它使用了显式的光传输模型，能够同时考虑遮挡和光照效应（阴影），并通过学习光源的可见性和环境天空颜色来解决这些逆向问题，同时保持线性复杂度。
   - **主要优势：** 该方法在生成逼真的图像方面表现出色，尤其是在未见过的视角和光照条件下。它能够准确估计地表高度（误差仅为几米），有效处理阴影问题，恢复有持久阴影的表面反射率，并能够定位和去除瞬态物体。

### 结论：

研究表明，**S-NeRF**在生成逼真的卫星图像方面表现出色，能够在复杂的光照和阴影效应下进行准确的3D形状估计。它为卫星影像中的阴影处理、表面反射率恢复和瞬态物体去除提供了一个有前景的解决方案。
